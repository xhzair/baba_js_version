<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baba is You - Psychology Experiment</title>
    
    <!-- jsPsych CSS and JS (Local) -->
    <script src="jspsych/dist/jspsych.js"></script>
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- jsPsych plugins (if needed for extensions) -->
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-survey-likert.js"></script>
    <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>
    <script src="jspsych/dist/plugin-survey-text.js"></script>
    <script src="jspsych/dist/plugin-fullscreen.js"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-call-function.js"></script>
    
    <!-- Our custom CSS -->
    <link href="css/baba-game.css" rel="stylesheet" type="text/css" />

    
    <style>
        .jspsych-survey-likert-statement, 
        .jspsych-survey-multi-choice-question,
        .jspsych-survey-text-question p,
        .jspsych-survey-likert-preamble,
        .jspsych-survey-multi-choice-preamble,
        .jspsych-survey-text-preamble {
            color: white !important;
            font-size: 22px !important;
            font-weight: normal !important;
            text-align: center !important;
            margin-bottom: 30px !important;
        }
        
        .jspsych-survey-likert-opts {
            font-size: 16px !important;
            padding-bottom: 20px !important;
        }
        
        .jspsych-survey-likert-opt-label {
            color: white !important;
            font-weight: normal !important;
        }
        
        .jspsych-survey-multi-choice-option {
            color: white !important;
            font-size: 18px !important;
            margin-bottom: 10px !important;
            text-align: left !important;
        }
        
        .jspsych-survey-multi-choice-text input[type="radio"] {
            margin-right: 8px !important;
        }
        
        input[type="text"], textarea {
            padding: 10px !important;
            font-size: 16px !important;
            width: 80% !important;
            max-width: 600px !important;
            border-radius: 5px !important;
            border: 1px solid #ddd !important;
        }
        
        .jspsych-btn {
            padding: 12px 24px !important;
            font-size: 18px !important;
            margin-top: 20px !important;
        }
        
        /* Progress bar styling */
        .progress-container {
            width: 60%;
            max-width: 600px;
            margin: 0 auto 40px auto;
            background-color: #333;
            border-radius: 10px;
            padding: 3px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 7px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
        }
        
        .progress-text {
            color: white;
            text-align: center;
            font-size: 22px;
            margin-bottom: 12px;
        }
        
        .question-prompt {
            font-size: 16px !important;
            color: white !important;
            margin-top: 5px;
            margin-bottom: 20px;
        }
        
        .fullscreen-warning {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 24px;
            font-size: 22px;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>
    
    <!-- Game engine and utilities -->
    <script src="js/game-engine.js"></script>
    <script src="js/experimental-conditions.js"></script>
    <script src="js/level-data.js"></script>
    
    <!-- jsPsych plugins -->
    <script src="js/jspsych-baba-game.js"></script>
    <script src="js/jspsych-baba-instructions.js"></script>
    <script src="js/jspsych-chapter-select.js"></script>
    <script src="js/jspsych-rating-scale.js"></script>
    <script src="js/jspsych-feedback-input.js"></script>
    <script src="js/jspsych-digit-span.js"></script>
    <script src="js/jspsych-dsst.js"></script>
    <script src="js/jspsych-aut.js"></script>
    <script src="js/jspsych-verbal-fluency.js"></script>
    <script src="js/jspsych-questionnaire.js"></script>
    <script src="js/jspsych-screening-questionnaire.js"></script>
    <script src="js/questionnaire-data.js"></script>
    <script src="js/lz-string.min.js"></script>
    
    <!-- Custom questionnaire utilities -->
    <script>
        // watch fullscreen status
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        // check if in fullscreen
        function isInFullScreen() {
            return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        }

        function handleFullscreenChange() {
            if (!isInFullScreen() && window.experimentStarted && !window.fullscreenViolation) {
                window.fullscreenViolation = true; // prevent multiple triggers

                // abort jsPsych (if initialized)
                if (typeof jsPsych !== 'undefined' && jsPsych?.abortExperiment) {
                    jsPsych.abortExperiment('Participant exited fullscreen');
                }

                // create overlay prompt
                const overlay = document.createElement('div');
                overlay.id = 'fullscreen-exit-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: black;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    color: white;
                    font-size: 28px;
                    text-align: center;
                `;

                overlay.innerHTML = `
                    <p>You have exited fullscreen mode.</p>
                    <p>The experiment will close automatically in <span id="fs-countdown">3</span> seconds.</p>
                `;
                document.body.appendChild(overlay);

                // try to close window after 3 seconds; if failed, refresh page to blank page
                let remaining = 3;
                const timer = setInterval(() => {
                    remaining--;
                    const span = document.getElementById('fs-countdown');
                    if (span) span.textContent = remaining.toString();
                    if (remaining <= 0) {
                        clearInterval(timer);
                        try {
                            window.close();
                            setTimeout(() => location.href = 'about:blank', 100);
                        } catch (e) {
                            location.href = 'about:blank';
                        }
                    }
                }, 1000);
            }
        }
        
        // add fullscreen guidance and control after original jsPsych initialization
        const originalJsPsych = initJsPsych;
        initJsPsych = function(options) {
            const jsPsych = originalJsPsych(options);
            
            // save original run method
            const originalRun = jsPsych.run;
            
            // override run method to add fullscreen guidance before starting
            jsPsych.run = function(timeline) {
                // create fullscreen instruction trial
                const fullscreenInstructions = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `
                        <h1 style="color: white;">Experiment will be conducted in fullscreen mode</h1>
                        <div style="color: white; max-width: 800px; margin: 0 auto; font-size: 18px; line-height: 1.6; text-align: left;">
                            <p>To ensure the validity of experimental data, this experiment must be conducted in <strong>fullscreen mode</strong>.</p>
                            <p>Please note:</p>
                            <ul style="text-align: left; padding-left: 20px;">
                                <li>After clicking the "Enter Fullscreen" button, the experiment will automatically switch to fullscreen mode</li>
                                <li>Please do not exit fullscreen mode during the experiment</li>
                                <li>Exiting fullscreen will be considered as <strong>exiting the experiment</strong></li>
                                <li>Ensure your device has sufficient battery and close any possible notification distractions</li>
                            </ul>
                            <p class="fullscreen-warning">Important: Please maintain fullscreen status throughout the entire experiment!</p>
                        </div>
                    `,
                    choices: ['Enter Fullscreen'],
                    on_finish: function() {
                        // mark experiment as started
                        window.experimentStarted = true;
                    }
                };
                
                // create fullscreen switch trial
                const enterFullscreen = {
                    type: jsPsychFullscreen,
                    fullscreen_mode: true,
                    message: `<p style="color: white;">The experiment is about to begin. Please maintain fullscreen status until the experiment ends.</p>`,
                    button_label: "Start Experiment"
                };
                
                // Add fullscreen guidance and switch to the beginning of timeline
                const newTimeline = [fullscreenInstructions, enterFullscreen].concat(timeline);
                
                // Call original run method
                originalRun.call(jsPsych, newTimeline);
            };
            
            return jsPsych;
        };
        
        // Function to group questions by source
        function groupQuestionsBySource(questions) {
            const groups = {};
            
            // Group 1: CPI, CSE, CMS
            groups.creativity = questions.filter(q => ['CPI', 'CSE', 'CMS'].includes(q.source));
            
            // Group 2: AARC
            groups.aarc = questions.filter(q => q.source === 'AARC');
            
            // Group 3: DEM
            groups.demographics = questions.filter(q => q.source === 'DEM');
            
            // Get attention check questions
            const attentionChecks = questions.filter(q => q.source === 'ATTENTION_CHECK');
            
            // Insert attention check 1 into creativity group (second to last position)
            if (attentionChecks.length >= 1 && groups.creativity.length > 0) {
                const insertIndex = Math.max(0, groups.creativity.length - 1);
                groups.creativity.splice(insertIndex, 0, attentionChecks[0]);
            }
            
            // Insert attention check 2 into aarc group (second to last position)
            if (attentionChecks.length >= 2 && groups.aarc.length > 0) {
                const insertIndex = Math.max(0, groups.aarc.length - 1);
                groups.aarc.splice(insertIndex, 0, attentionChecks[1]);
            }
            
            return groups;
        }
        
        // Function to create question trials in one-by-one format
        function createQuestionTrials(questions, groupName, participantId, startIdx = 0) {
            const trials = [];
            const totalQuestions = questions.length;
            
            // Introduction page for this group
            let introTitle, introText;
            if (groupName === 'creativity') {
                introTitle = "Creativity Questionnaire";
                introText = "The following questions are about your creative abilities and beliefs about creativity.";
            } else if (groupName === 'aarc') {
                introTitle = "Age-related Changes Questionnaire";
                introText = "The following questions are about how you perceive age-related changes in your life.";
            } else if (groupName === 'demographics') {
                introTitle = "Demographics Questionnaire";
                introText = "The following questions are about your background information.";
            }
            
            trials.push({
                type: jsPsychHtmlButtonResponse,
                stimulus: `<h2 style='color:white;'>${introTitle}</h2><p style='color:white;'>${introText}</p>`,
                choices: ['Continue'],
                data: { 
                    trial_type: 'questionnaire_intro',
                    participant_id: participantId,
                    questionnaire_group: groupName
                }
            });
            
            // Create a trial for each question
            questions.forEach((question, idx) => {
                const questionIdx = idx + startIdx;
                const progressPercent = Math.round(((idx + 1) / totalQuestions) * 100);
                
                const progressBar = `
                    <div class="progress-text">Question ${idx + 1} of ${totalQuestions}</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width:${progressPercent}%;">${progressPercent}%</div>
                    </div>
                `;
                
                if (question.type === 'likert') {
                    // Using HTML keyboard response with custom buttons
                    const buttonChoices = question.options.map(opt => opt.text);
                    
                    // Determine button width based on number of choices
                    const buttonWidth = buttonChoices.length <= 5 ? 120 : Math.max(80, Math.floor(600 / buttonChoices.length));
                    
                    // Create buttons HTML
                    let buttonsHTML = '';
                    buttonChoices.forEach((choice, idx) => {
                        buttonsHTML += `<button 
                            class="jspsych-custom-btn" 
                            data-choice="${idx}" 
                            style="width:${buttonWidth}px; height:50px; margin:10px 5px; padding:5px 10px; font-size:16px; background-color:#f0f0f0; border:1px solid #ccc; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center;"
                            >${choice}</button>`;
                    });
                    
                    // Handle prompt for likert questions
                    let promptHtml = '';
                    if (question.prompt) {
                        promptHtml = `<div class="question-prompt">${question.prompt}</div>`;
                    }
                    
                    trials.push({
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `
                            <div style="width:100%; max-width:800px; margin:0 auto; overflow:hidden;">
                                ${progressBar}
                                <div style="color:white; font-size:22px; margin-bottom:20px; text-align:center;">
                                    ${question.question}
                                </div>
                                ${promptHtml}
                                <div style="display:flex; flex-direction:row; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:20px;">
                                    ${buttonsHTML}
                                </div>
                                <div style="margin-top:20px; text-align:center;">
                                    <button id="confirm-btn" style="padding:12px 25px; font-size:18px; background-color:#888888; color:white; border:none; border-radius:5px; cursor:not-allowed; min-width:150px;">Confirm</button>
                                </div>
                                <div id="selection-text" style="color:white; margin-top:15px; font-size:16px; min-height:30px; text-align:center;"></div>
                            </div>
                        `,
                        choices: "NO_KEYS",
                        data: { 
                            trial_type: 'questionnaire_likert',
                            participant_id: participantId,
                            questionId: question.id,
                            questionSource: question.source,
                            questionType: question.type,
                            is_attention_check: question.is_attention_check || false,
                            correct_answer: question.correct_answer || null
                        },
                        on_load: function() {
                            let selectedChoice = null;
                            const confirmBtn = document.getElementById('confirm-btn');
                            const selectionText = document.getElementById('selection-text');
                            
                            confirmBtn.disabled = true;
                            
                            // Add click event listeners to buttons
                            document.querySelectorAll('.jspsych-custom-btn').forEach(btn => {
                                btn.addEventListener('click', function(e) {
                                    const choiceIdx = parseInt(this.getAttribute('data-choice'));
                                    
                                    // Reset all buttons to default style
                                    document.querySelectorAll('.jspsych-custom-btn').forEach(b => {
                                        b.style.backgroundColor = '#f0f0f0';
                                        b.style.color = '#000000';
                                    });
                                    
                                    // Highlight selected button
                                    this.style.backgroundColor = '#4CAF50';
                                    this.style.color = 'white';
                                    
                                    // Show selection text
                                    selectionText.textContent = `You selected: ${buttonChoices[choiceIdx]}`;
                                    
                                    // Enable confirm button
                                    confirmBtn.disabled = false;
                                    confirmBtn.style.backgroundColor = '#4CAF50';
                                    confirmBtn.style.cursor = 'pointer';
                                    
                                    // Store selected choice
                                    selectedChoice = choiceIdx;
                                });
                            });
                            
                            // Add click event listener to confirm button
                            confirmBtn.addEventListener('click', function() {
                                if (!this.disabled && selectedChoice !== null) {
                                    // Check if this is an attention check question
                                    const isCorrect = question.is_attention_check ? 
                                        (selectedChoice + 1 === question.correct_answer) : null;
                                    
                                    // If attention check failed, show warning and don't proceed
                                    if (question.is_attention_check && !isCorrect) {
                                        // Create attention check warning popup
                                        const warningOverlay = document.createElement('div');
                                        warningOverlay.id = 'attention-warning-overlay';
                                        warningOverlay.style.cssText = `
                                            position: fixed;
                                            top: 0;
                                            left: 0;
                                            width: 100%;
                                            height: 100%;
                                            background-color: rgba(0, 0, 0, 0.7);
                                            display: flex;
                                            justify-content: center;
                                            align-items: center;
                                            z-index: 10000;
                                            font-family: Arial, sans-serif;
                                        `;
                                        
                                        const messageBox = document.createElement('div');
                                        messageBox.style.cssText = `
                                            background-color: white;
                                            padding: 30px;
                                            border-radius: 10px;
                                            text-align: center;
                                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                                            max-width: 500px;
                                        `;
                                        
                                        const title = document.createElement('h2');
                                        title.textContent = 'Attention Check Failed';
                                        title.style.cssText = `
                                            color: #f44336;
                                            margin-bottom: 20px;
                                            font-size: 24px;
                                        `;
                                        
                                        const message = document.createElement('p');
                                        message.textContent = 'We detected that you may not have read the question carefully. Please re-answer this question and read all options carefully.';
                                        message.style.cssText = `
                                            color: #333;
                                            font-size: 16px;
                                            margin-bottom: 20px;
                                            line-height: 1.5;
                                        `;
                                        
                                        const button = document.createElement('button');
                                        button.textContent = 'I Understand';
                                        button.className = 'baba-button';
                                        button.style.cssText = `
                                            background-color: #4CAF50;
                                            border: none;
                                            color: white;
                                            padding: 10px 20px;
                                            text-align: center;
                                            text-decoration: none;
                                            display: inline-block;
                                            font-size: 16px;
                                            margin: 10px 2px;
                                            cursor: pointer;
                                            border-radius: 5px;
                                        `;
                                        
                                        messageBox.appendChild(title);
                                        messageBox.appendChild(message);
                                        messageBox.appendChild(button);
                                        warningOverlay.appendChild(messageBox);
                                        document.body.appendChild(warningOverlay);
                                        
                                        // Click button to close warning and reset
                                        button.addEventListener('click', () => {
                                            warningOverlay.remove();
                                            // Reset the selection
                                            selectedChoice = null;
                                            confirmBtn.disabled = true;
                                            confirmBtn.style.backgroundColor = '#888888';
                                            confirmBtn.style.cursor = 'not-allowed';
                                            selectionText.textContent = '';
                                            
                                            // Reset all buttons to default style
                                            document.querySelectorAll('.jspsych-custom-btn').forEach(b => {
                                                b.style.backgroundColor = '#f0f0f0';
                                                b.style.color = '#000000';
                                            });
                                        });
                                        
                                        return; // Don't proceed with the trial
                                    }
                                    
                                    // End trial and pass the selected value
                                    jsPsych.finishTrial({
                                        rt: performance.now(),
                                        response: selectedChoice,
                                        question_id: question.id,
                                        question_source: question.source,
                                        question_type: question.type,
                                        question_response: {
                                            [`Q${question.id}`]: selectedChoice + 1 // +1 to match original 1-5 scale
                                        },
                                        is_attention_check: question.is_attention_check || false,
                                        correct_answer: question.correct_answer || null,
                                        is_correct: isCorrect
                                    });
                                }
                            });
                        }
                    });
                } else if (question.type === 'option') {
                    // Using HTML keyboard response with custom buttons
                    const buttonChoices = question.options.map(opt => opt.text);
                    
                    // Create buttons HTML - options can be longer text, so keep them stacked
                    let buttonsHTML = '';
                    buttonChoices.forEach((choice, idx) => {
                        buttonsHTML += `<button 
                            class="jspsych-custom-btn" 
                            data-choice="${idx}" 
                            style="width:80%; min-height:50px; margin:8px; padding:12px 15px; font-size:16px; background-color:#f0f0f0; border:1px solid #ccc; border-radius:4px; cursor:pointer; text-align:left;"
                            >${choice}</button>`;
                    });
                    
                    // Handle prompt for option questions
                    let promptHtml = '';
                    if (question.prompt) {
                        promptHtml = `<div class="question-prompt">${question.prompt}</div>`;
                    }
                    
                    trials.push({
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `
                            <div style="width:100%; max-width:800px; margin:0 auto; overflow:hidden;">
                                ${progressBar}
                                <div style="color:white; font-size:22px; margin-bottom:20px; text-align:center;">
                                    ${question.question}
                                </div>
                                ${promptHtml}
                                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
                                    ${buttonsHTML}
                                </div>
                                <div style="margin-top:20px; text-align:center;">
                                    <button id="confirm-btn" style="padding:12px 25px; font-size:18px; background-color:#888888; color:white; border:none; border-radius:5px; cursor:not-allowed; min-width:150px;">Confirm</button>
                                </div>
                                <div id="selection-text" style="color:white; margin-top:15px; font-size:16px; min-height:30px; text-align:center;"></div>
                            </div>
                        `,
                        choices: "NO_KEYS",
                        data: { 
                            trial_type: 'questionnaire_option',
                            participant_id: participantId,
                            questionId: question.id,
                            questionSource: question.source,
                            questionType: question.type,
                            is_attention_check: question.is_attention_check || false,
                            correct_answer: question.correct_answer || null
                        },
                        on_load: function() {
                            let selectedChoice = null;
                            const confirmBtn = document.getElementById('confirm-btn');
                            const selectionText = document.getElementById('selection-text');
                            
                            confirmBtn.disabled = true;
                            
                            // Add click event listeners to buttons
                            document.querySelectorAll('.jspsych-custom-btn').forEach(btn => {
                                btn.addEventListener('click', function(e) {
                                    const choiceIdx = parseInt(this.getAttribute('data-choice'));
                                    
                                    // Reset all buttons to default style
                                    document.querySelectorAll('.jspsych-custom-btn').forEach(b => {
                                        b.style.backgroundColor = '#f0f0f0';
                                        b.style.color = '#000000';
                                    });
                                    
                                    // Highlight selected button
                                    this.style.backgroundColor = '#4CAF50';
                                    this.style.color = 'white';
                                    
                                    // Show selection text
                                    selectionText.textContent = `You selected: ${buttonChoices[choiceIdx]}`;
                                    
                                    // Enable confirm button
                                    confirmBtn.disabled = false;
                                    confirmBtn.style.backgroundColor = '#4CAF50';
                                    confirmBtn.style.cursor = 'pointer';
                                    
                                    // Store selected choice
                                    selectedChoice = choiceIdx;
                                });
                            });
                            
                            // Add click event listener to confirm button
                            confirmBtn.addEventListener('click', function() {
                                if (!this.disabled && selectedChoice !== null) {
                                    // Check if this is an attention check question
                                    const isCorrect = question.is_attention_check ? 
                                        (selectedChoice + 1 === question.correct_answer) : null;
                                    
                                    // If attention check failed, show warning and don't proceed
                                    if (question.is_attention_check && !isCorrect) {
                                        // Create attention check warning popup
                                        const warningOverlay = document.createElement('div');
                                        warningOverlay.id = 'attention-warning-overlay';
                                        warningOverlay.style.cssText = `
                                            position: fixed;
                                            top: 0;
                                            left: 0;
                                            width: 100%;
                                            height: 100%;
                                            background-color: rgba(0, 0, 0, 0.7);
                                            display: flex;
                                            justify-content: center;
                                            align-items: center;
                                            z-index: 10000;
                                            font-family: Arial, sans-serif;
                                        `;
                                        
                                        const messageBox = document.createElement('div');
                                        messageBox.style.cssText = `
                                            background-color: white;
                                            padding: 30px;
                                            border-radius: 10px;
                                            text-align: center;
                                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                                            max-width: 500px;
                                        `;
                                        
                                        const title = document.createElement('h2');
                                        title.textContent = 'Attention Check Failed';
                                        title.style.cssText = `
                                            color: #f44336;
                                            margin-bottom: 20px;
                                            font-size: 24px;
                                        `;
                                        
                                        const message = document.createElement('p');
                                        message.textContent = 'We detected that you may not have read the question carefully. Please re-answer this question and read all options carefully.';
                                        message.style.cssText = `
                                            color: #333;
                                            font-size: 16px;
                                            margin-bottom: 20px;
                                            line-height: 1.5;
                                        `;
                                        
                                        const button = document.createElement('button');
                                        button.textContent = 'I Understand';
                                        button.className = 'baba-button';
                                        button.style.cssText = `
                                            background-color: #4CAF50;
                                            border: none;
                                            color: white;
                                            padding: 10px 20px;
                                            text-align: center;
                                            text-decoration: none;
                                            display: inline-block;
                                            font-size: 16px;
                                            margin: 10px 2px;
                                            cursor: pointer;
                                            border-radius: 5px;
                                        `;
                                        
                                        messageBox.appendChild(title);
                                        messageBox.appendChild(message);
                                        messageBox.appendChild(button);
                                        warningOverlay.appendChild(messageBox);
                                        document.body.appendChild(warningOverlay);
                                        
                                        // Click button to close warning and reset
                                        button.addEventListener('click', () => {
                                            warningOverlay.remove();
                                            // Reset the selection
                                            selectedChoice = null;
                                            confirmBtn.disabled = true;
                                            confirmBtn.style.backgroundColor = '#888888';
                                            confirmBtn.style.cursor = 'not-allowed';
                                            selectionText.textContent = '';
                                            
                                            // Reset all buttons to default style
                                            document.querySelectorAll('.jspsych-custom-btn').forEach(b => {
                                                b.style.backgroundColor = '#f0f0f0';
                                                b.style.color = '#000000';
                                            });
                                        });
                                        
                                        return; // Don't proceed with the trial
                                    }
                                    
                                    // End trial and pass the selected value
                                    jsPsych.finishTrial({
                                        rt: performance.now(),
                                        response: selectedChoice,
                                        question_id: question.id,
                                        question_source: question.source,
                                        question_type: question.type,
                                        question_response: {
                                            [`Q${question.id}`]: buttonChoices[selectedChoice]
                                        },
                                        is_attention_check: question.is_attention_check || false,
                                        correct_answer: question.correct_answer || null,
                                        is_correct: isCorrect
                                    });
                                }
                            });
                        }
                    });
                } else if (question.id === 29 || question.id === 32) {
                    // custom number input validation (age related questions)
                    let promptHtml = '';
                    if (question.prompt) {
                        promptHtml = `<div class="question-prompt">${question.prompt}</div>`;
                    }

                    trials.push({
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `
                            <div style="width:100%; max-width:800px; margin:0 auto; overflow:hidden;">
                                ${progressBar}
                                <div style="color:white; font-size:22px; margin-bottom:20px; text-align:center;">
                                    ${question.question}
                                </div>
                                ${promptHtml}
                                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:20px;">
                                    <input id="age-input" type="text" style="width:200px; height:40px; font-size:18px; text-align:center; border-radius:6px;" placeholder="Enter number" />
                                    <div id="age-validation" style="color:#ff6b6b; font-size:16px; margin-top:8px; display:none;"></div>
                                </div>
                                <div style="text-align:center;">
                                    <button id="age-next" class="baba-button" disabled style="padding:12px 25px; font-size:18px;">Continue</button>
                                </div>
                            </div>
                        `,
                        choices: "NO_KEYS",
                        data: {
                            trial_type: 'questionnaire_age',
                            participant_id: participantId,
                            questionId: question.id,
                            questionSource: question.source,
                            questionType: question.type
                        },
                        on_load: function() {
                            const input = document.getElementById('age-input');
                            const nextBtn = document.getElementById('age-next');
                            const validationDiv = document.getElementById('age-validation');

                            const validateInput = () => {
                                const val = input.value.trim();
                                const isNumber = /^\d+$/.test(val);
                                let valid = false;
                                if (isNumber) {
                                    const num = parseInt(val);
                                    if (question.id === 29) {
                                        valid = num >= 18 && num <= 100;
                                    } else {
                                        valid = true; // subjective age only needs numbers
                                    }
                                }
                                if (valid) {
                                    validationDiv.style.display = 'none';
                                    nextBtn.disabled = false;
                                } else {
                                    validationDiv.textContent = question.id === 29 ? 'Please enter a number between 18 and 100' : 'Please enter a number';
                                    validationDiv.style.display = 'block';
                                    nextBtn.disabled = true;
                                }
                            };

                            input.addEventListener('input', validateInput);

                            nextBtn.addEventListener('click', () => {
                                jsPsych.finishTrial({
                                    rt: performance.now(),
                                    response: input.value.trim(),
                                    question_id: question.id,
                                    question_source: question.source,
                                    question_type: question.type
                                });
                            });
                        }
                    });
                } else if (question.type === 'text') {
                    let promptHtml = '';
                    if (question.prompt) {
                        promptHtml = `<div class="question-prompt">${question.prompt}</div>`;
                    }
                    
                    trials.push({
                        type: jsPsychSurveyText,
                        questions: [{
                            prompt: question.question,
                            name: `Q${question.id}`,
                            placeholder: "Type your answer here",
                            rows: 2,
                            columns: 50,
                            required: true
                        }],
                        preamble: `${progressBar}${promptHtml}`,
                        button_label: 'Continue',
                        data: { 
                            trial_type: 'questionnaire_text',
                            participant_id: participantId,
                            questionId: question.id,
                            questionSource: question.source,
                            questionType: question.type
                        }
                    });
                }
            });
            
            return trials;
        }
    </script>

    <!-- Main experiment script (loaded after fullscreen override) -->
    <script src="js/experiment.js"></script>
</body>
</html> 